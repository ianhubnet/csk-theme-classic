name: Release and Dispatch

on:
  push:
    tags:
      - '*'
      - '!*alpha*'
      - '!*beta*'

permissions:
  contents: write

jobs:
  release:
    name: Package and Release
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.vars.outputs.tag }}
      name: ${{ steps.vars.outputs.name }}
      zip: ${{ steps.vars.outputs.zip }}

    steps:
      # 1. Checkout code
      - name: 1️⃣ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Set up variables
      - name: 2️⃣ Set up variables
        id: vars
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          NAME="${{ vars.CSK_NAME }}"
          ZIP_NAME="${NAME}-${TAG_NAME}.zip"
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "zip=$ZIP_NAME" >> $GITHUB_OUTPUT

      # 3. Prepare ZIP contents
      - name: 3️⃣ Prepare ZIP contents
        run: |
          if [ ! -d "src" ]; then
            echo "::error::src not found"
            exit 1
          fi

          mkdir "${{ steps.vars.outputs.name }}"
          cp -r src "${{ steps.vars.outputs.name }}/"

          if [ -d "assets" ]; then
            cp -r assets "${{ steps.vars.outputs.name }}/"
          fi

          for f in README.md LICENSE.md; do
            if [ -f "$f" ]; then
              cp "$f" "${{ steps.vars.outputs.name }}/"
            fi
          done

      # 4. Create ZIP archive
      - name: 4️⃣ Create ZIP archive
        run: |
          zip -r "${{ steps.vars.outputs.zip }}" "${{ steps.vars.outputs.name }}"

      # 5. Create GitHub Release and Upload ZIP
      - name: 5️⃣ Create GitHub Release and Upload ZIP
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          files: ${{ steps.vars.outputs.zip }}

  dispatch:
    name: Notify Packages
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Trigger update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.CSK_PAT }}
          repository: ianhubnet/csk-packages
          event-type: update-submodules
          client-payload: |
            {
              "type": "${{ vars.CSK_TYPE }}",
              "name": "${{ vars.CSK_NAME }}",
              "repo": "${{ github.repository }}"
            }
